<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://michaeljflynn.net/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://michaeljflynn.net/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="mflynn" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Computational Physics, Dynamic Programming, Haskell, Partition Function, Recursion, RNA, misc, " />

<meta property="og:title" content="Simple RNA folding in 130 lines of Haskell "/>
<meta property="og:url" content="https://michaeljflynn.net/simple-rna-folding-in-130-lines-of-haskell.html" />
<meta property="og:description" content="Note: imported from an earlier version of this blog. Sorry if anything is broken. How do we predict how RNA folds? First of all, we need to define what we mean by folding. RNA is a polymer made up of nucleic acids: adenine, guanine, cytosine, and uracil. There are 3 …" />
<meta property="og:site_name" content="Michael J. Flynn&#39;s blog" />
<meta property="og:article:author" content="mflynn" />
<meta property="og:article:published_time" content="2017-01-09T00:56:00-08:00" />
<meta name="twitter:title" content="Simple RNA folding in 130 lines of Haskell ">
<meta name="twitter:description" content="Note: imported from an earlier version of this blog. Sorry if anything is broken. How do we predict how RNA folds? First of all, we need to define what we mean by folding. RNA is a polymer made up of nucleic acids: adenine, guanine, cytosine, and uracil. There are 3 …">

        <title>Simple RNA folding in 130 lines of Haskell  · Michael J. Flynn&#39;s blog
</title>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://michaeljflynn.net/"><span class=site-name>Michael J. Flynn's blog </span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://michaeljflynn.net
                                    >Home</a>
                                </li>
                                <li ><a href="https://michaeljflynn.net/pages/about-me.html">About Me!</a></li>
                                <li ><a href="https://michaeljflynn.net/categories.html">Categories</a></li>
                                <li ><a href="https://michaeljflynn.net/tags.html">Tags</a></li>
                                <li ><a href="https://michaeljflynn.net/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://michaeljflynn.net/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                  <div class="span3 sidebar">
		    <div class="profile">
		      <img src="https://michaeljflynn.net/theme/images/profile.jpg" alt="Me at my thesis defense." class="profile-pic">
		      <h3>Michael J. Flynn</h3>
		      <p>Welcome to my blog!</p>
		    </div>
		    <div class="social-links">
		      <a href="https://github.com/YourUsername" target="_blank">GitHub</a><br>
		      <a href="https://twitter.com/Michaeljaflynn" target="_blank">Twitter</a><br>
		      <a href="mailto:you@example.com">Email</a>
		    </div>
		  </div>
                    <div class="span9">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10">
        <h1>
            <a href="https://michaeljflynn.net/simple-rna-folding-in-130-lines-of-haskell.html">
                Simple RNA folding in 130 lines of Haskell
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span10 article-content">
            
            <p><em><em>Note: imported from an earlier version of this blog. Sorry if anything is broken</em>.</em></p>
<p><link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"
      crossorigin="anonymous"></p>
<p><img alt="RNA secondary structure" src="https://michaeljflynn.net/RNAt.svg"></p>
<p>How do we predict how RNA folds? First of all, we need to define what we
mean by folding. RNA is a polymer made up of nucleic acids: adenine,
guanine, cytosine, and uracil. There are 3 levels of RNA structure that
are traditionally considered:</p>
<ul>
<li><strong>primary structure:</strong>the sequence of bases, ‘A’, ‘G’, ‘C’, and ‘U’
  that form the strand of RNA, ‘AAAAGGGGCCCCUUUU’ for example,</li>
<li><strong>secondary structure:</strong> which bases are hydrogen bonded together, ‘A’
  to ‘U’ and ‘G’ to ‘C’, can be specified by a sequence of pairs
  corresponding to which indices are paired together (1,24), (2,23)…,
  and</li>
<li><strong>tertiary structure:</strong>how the molecule bends on itself on a larger
  scale.</li>
</ul>
<p>Usually, primary structure is already known or given as an input and
tertiary structure is hard to specify and compute the energy for.
Secondary structure is easy to specify using a sequence of pairs and the
energy is roughly dominated by hydrogen bonding between bases which is
discrete.  Since RNA functions mostly by binding to things using exposed
(non-paired) bases, the secondary structure is also the most relevant
when discerning function. For these reasons, biophysicists usually focus
on predicting the secondary structure of RNA.</p>
<p>From the laws of thermal physics, if RNA is modeled as a system in
thermal equilibrium then the probability of any state <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> with free
energy <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">E(s)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span> is
equal to</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><mrow><mo>−</mo><mi>E</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>k</mi><mi>T</mi></mrow></msup><mrow><munder><mo>∑</mo><mrow><msup><mi>s</mi><mo lspace="0em" mathvariant="normal" rspace="0em">′</mo></msup><mo>∈</mo><mi>S</mi></mrow></munder><msup><mi>e</mi><mrow><mo>−</mo><mi>E</mi><mo stretchy="false">(</mo><msup><mi>s</mi><mo lspace="0em" mathvariant="normal" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>k</mi><mi>T</mi></mrow></msup></mrow></mfrac><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">P(s)= \frac{e^{-E(s)/kT}}{\sum_{s' \in S} e^{-E(s')/kT}},</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.5961em;vertical-align:-1.0311em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.296em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3271em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">s</span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0311em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span></span></p>
<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> is the full set of states. The denominator is called the
<em>partition function</em>, usually denoted <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span>, it normalizes the
probability distribution and with it we can compute the probability of
any structure. How many terms are in the partition function? How many
states are in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>? Depends on what assumptions you make. In full
generality, even only allowing Watson-Crick base pairs, there are
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">!</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n!)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">!)</span></span></span></span> terms in that sum. However, if you assume that there are no
<em>crossing</em> pairs, i.e. arcs that would intersect in the above diagram,
or pairs <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>l</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(i,j), (k,l)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span></span></span></span> such that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>&lt;</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">i &lt; k</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>&lt;</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">k &lt; j</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>&lt;</mo><mi>l</mi></mrow><annotation encoding="application/x-tex">j &lt; l</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>, there
are only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1.</mn><msup><mn>8</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1.8^n)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1.</span><span class="mord"><span class="mord">8</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> terms in the sum. This is still an exponential
quantity, but it turns out it is actually computable in
sub-exponential time via dynamic programming. This assumption is
called the <em>no-pseudoknot assumption,</em> and it means that if I have an
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(i,j)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span> pair, then for all bases in-between them, I can ignore all the
bases outside of them when enumerating structures. This begs the
question whether it is a physically valid assumption. The answer is
NO. There are many RNAs found in nature that have “crossing” pairs
such as <a href="https://en.wikipedia.org/wiki/Group_I_catalytic_intron">Group
I</a> and <a href="https://en.wikipedia.org/wiki/Group_II_intron">Group
II</a> introns. However,
without this assumption, computing the partition function is
intractable, so most RNA folding software packages make it.</p>
<p>While it is tempting to do analysis on a structure with the minimum free
energy and highest probability, since RNA is a thermal system with an
exponential multiplicity of states even the probability of the most
probable state is extremely low and any quantity computed on even the
most probable state has negligible contribution to the physical expected
value of that quantity. However, I will show here that not only can we
compute the partition function, but we can also sample from the
Boltzmann distribution. Once we are able to do that we can compute
arbitrary expected values on the full Boltzmann distribution via Monte
Carlo integration. (In fact, Monte Carlo integration is not even needed
if you can express your quantity in terms of the partition function
values, which can give you full expected values without statistical
error! But that is outside of the scope of this post).</p>
<p>Putting this all together, to predict the folding and general properties
of RNA we need 4 things:</p>
<ul>
<li>a specification of a state of RNA <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span>,</li>
<li>an energy function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>:</mo><mi>S</mi><mo>→</mo><mtext>Energy</mtext></mrow><annotation encoding="application/x-tex">E(s): S \to \text{Energy}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Energy</span></span></span></span></span>, which takes a state
  and outputs a physical energy,</li>
<li>the partition function, the sum of the Boltzmann factors over every
  possible state <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><msub><mo>∑</mo><mrow><msup><mi>s</mi><mo lspace="0em" mathvariant="normal" rspace="0em">′</mo></msup><mo>∈</mo><mi>S</mi></mrow></msub><msup><mi>e</mi><mrow><mo>−</mo><mi>E</mi><mo stretchy="false">(</mo><msup><mi>s</mi><mo lspace="0em" mathvariant="normal" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>k</mi><mi>T</mi></mrow></msup></mrow><annotation encoding="application/x-tex">Z = \sum_{s' \in S} e^{-E(s')/kT}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2696em;vertical-align:-0.3271em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3271em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span>, and</li>
<li>an algorithm for sampling structures from the Boltzmann distribution,
  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>E</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>k</mi><mi>T</mi></mrow></msup><mi mathvariant="normal">/</mi><mi>Z</mi></mrow><annotation encoding="application/x-tex">P(s) = e^{-E(s)/kT}/Z</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">s</span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span></li>
</ul>
<p><strong>Quick Code Note</strong></p>
<p>All code going forward will be in Haskell. You should be able to extract
all the code here into a file and it should compile. To set up our
environment, make sure to have this header at the top of the file:</p>
<div class="highlight"><pre><span></span><code><span class="cm">{-# LANGUAGE NoMonomorphismRestriction #-}</span>
<span class="cm">{-# LANGUAGE FlexibleContexts          #-}</span>
<span class="cm">{-# LANGUAGE TypeFamilies              #-}</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.Array</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.Time.Clock.POSIX</span><span class="w"> </span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.Colour</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">System.Random</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.List</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Diagrams.Prelude</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Diagrams.Backend.SVG.CmdLine</span>
</code></pre></div>

<p><strong>States of RNA</strong></p>
<p>Because of the no-pseudoknot assumption, we can actually specify the
states using a recursive data structure.</p>
<div class="highlight"><pre><span></span><code><span class="kr">data</span><span class="w"> </span><span class="kt">Structure</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Paired</span><span class="w"> </span><span class="kt">Char</span><span class="w"> </span><span class="kt">Char</span><span class="w"> </span><span class="p">(</span><span class="kt">Structure</span><span class="p">,</span><span class="w"> </span><span class="kt">Structure</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">                 </span><span class="kt">Slip</span><span class="w"> </span><span class="kt">Char</span><span class="w"> </span><span class="kt">Structure</span><span class="w"> </span><span class="o">|</span>
<span class="w">                 </span><span class="kt">None</span>
<span class="w">               </span><span class="kr">deriving</span><span class="w"> </span><span class="kt">Show</span>
</code></pre></div>

<p>The thought behind this definition is that we are specifying the
structure base by base. If base <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> is unpaired, then we move on to
the next base. If base <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> is paired, then we fork the structure into
the bases <em>underneath </em>the pair and the bases <em>after </em>the pair.  We
carry along the letter of the base for convenience and to compute the
energies of any pairing that might happen.</p>
<p><strong>Energy Model</strong></p>
<p>A fully realistic energy model of RNA would be very difficult to
compute. There are exposed ions everywhere on the strand which
interact with each other and there is tension in the backbone. Many of
these interactions are non-linear which breaks the recursion and
therefore computability of the problem. In practice, there are several
levels of complexity that are implemented which try to account for the
non-linearities in a computable fashion (this actually is the only
difference between professional RNA secondary structure prediction and
an Algorithms homework problem). Here I will implement a very simple
energy model: adding the free energies of each hydrogen bond. A
hydrogen bond contributes about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>6</mn><mtext> kJ</mtext><mi mathvariant="normal">/</mi><mtext>mol</mtext><mo>=</mo><mo>−</mo><mn>2.3</mn><mtext> </mtext><msub><mi>k</mi><mi>B</mi></msub><mi>T</mi></mrow><annotation encoding="application/x-tex">-6\ \text{kJ}/\text{mol} = -2.3\
k_BT</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mord">6</span><span class="mspace"> </span><span class="mord text"><span class="mord">kJ</span></span><span class="mord">/</span><span class="mord text"><span class="mord">mol</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord">−</span><span class="mord">2.3</span><span class="mspace"> </span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span>. Adenine-uracil bonds have 2 hydrogen bonds, guanine-cytosine
bonds have 3. Therefore in the exponent of the Boltzmann factor, I
will put -4.6 for A-U bonds and -6.9 for G-C bonds. Anything else is
represented by infinite energy, meaning that it will never happen.</p>
<div class="highlight"><pre><span></span><code><span class="nf">baseEnergy</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Char</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Char</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Double</span>
<span class="nf">baseEnergy</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="kr">of</span>
<span class="w">  </span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;U&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="o">-</span><span class="mf">4.6</span>
<span class="w">  </span><span class="p">(</span><span class="sc">&#39;G&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;C&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="o">-</span><span class="mf">6.9</span>
<span class="w">  </span><span class="p">(</span><span class="sc">&#39;U&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="o">-</span><span class="mf">4.6</span>
<span class="w">  </span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;G&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="o">-</span><span class="mf">6.9</span>
<span class="w">  </span><span class="n">otherwise</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="mf">0.0</span><span class="w"> </span><span class="c1">-- non-allowed pairs treated like an infinite hill</span>

<span class="nf">energyModel</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Structure</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Double</span>
<span class="nf">energyModel</span><span class="w"> </span><span class="p">(</span><span class="kt">Paired</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">))</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">(</span><span class="n">baseEnergy</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1">-- energy of pair</span>
<span class="w">  </span><span class="p">(</span><span class="n">energyModel</span><span class="w"> </span><span class="n">s1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1">-- energy of substructure under pair</span>
<span class="w">  </span><span class="p">(</span><span class="n">energyModel</span><span class="w"> </span><span class="n">s2</span><span class="p">)</span><span class="w"> </span><span class="c1">-- energy of substructure after pair</span>
<span class="nf">energyModel</span><span class="w"> </span><span class="p">(</span><span class="kt">Slip</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">energyModel</span><span class="w"> </span><span class="n">s</span>
<span class="nf">energyModel</span><span class="w"> </span><span class="kt">None</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span>
</code></pre></div>

<p><strong>Partition Function</strong></p>
<p>The sum <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><msub><mo>∑</mo><mrow><msup><mi>s</mi><mo lspace="0em" mathvariant="normal" rspace="0em">′</mo></msup><mo>∈</mo><mi>S</mi></mrow></msub><msup><mi>e</mi><mrow><mo>−</mo><mi>E</mi><mo stretchy="false">(</mo><msup><mi>s</mi><mo lspace="0em" mathvariant="normal" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>k</mi><mi>T</mi></mrow></msup></mrow><annotation encoding="application/x-tex">Z = \sum_{s' \in S} e^{-E(s')/kT}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2696em;vertical-align:-0.3271em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3271em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9425em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8278em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> initially seems
daunting. However, from the recursive definition of our energy model,
we can easily see that the partition function can be defined
recursively as well. To be precise, if we define <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">Z[i,j]</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span> as the
sub-partition-function from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>, it must be equal to the sum of
the Boltzmann terms of all structures where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> is paired and all
structures where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> is unpaired:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo><mo>=</mo><mover><mover><mrow><mi>Z</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><mo stretchy="true">⏞</mo></mover><mrow><mi>i</mi><mtext> unpaired</mtext></mrow></mover><mo>+</mo><mover><mover><mrow><munder><mo>∑</mo><mrow><mi>i</mi><mo>&lt;</mo><mi>k</mi><mo>≤</mo><mi>j</mi></mrow></munder><mi>B</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo><mi>Z</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>k</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mi>Z</mi><mo stretchy="false">[</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><mo stretchy="true">⏞</mo></mover><mrow><mi>i</mi><mtext> paired</mtext></mrow></mover></mrow><annotation encoding="application/x-tex">Z[i, j] = \overbrace{Z[i+1, j]}^{i \text{ unpaired}} + \overbrace{\sum_{i &lt; k \leq j} B(i, k) Z[i+1, k-1] Z[k+1, j]}^{i \text{ paired}}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4702em;vertical-align:-0.25em;"></span><span class="mord mover"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.2202em;"><span style="top:-3.398em;"><span class="pstrut" style="height:3.398em;"></span><span class="mord mover"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.398em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span><span class="svg-align" style="top:-3.85em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg height="0.548em" preserveAspectRatio="xMinYMin slice" viewBox="0 0 400000 548" width="400em" xmlns="http://www.w3.org/2000/svg"><path d="M6 548l-6-6v-35l6-11c56-104 135.3-181.3 238-232 57.3-28.7 117 -45 179-50h399577v120H403c-43.3 7-81 15-113 26-100.7 33-179.7 91-237 174-2.7  5-6 9-10 13-.7 1-7.3 1-20 1H6z"></path></svg></span><span class="brace-center" style="height:0.548em;"><svg height="0.548em" preserveAspectRatio="xMidYMin slice" viewBox="0 0 400000 548" width="400em" xmlns="http://www.w3.org/2000/svg"><path d="M200428 334 c-100.7-8.3-195.3-44-280-108-55.3-42-101.7-93-139-153l-9-14c-2.7 4-5.7 8.7-9 14 -53.3 86.7-123.7 153-211 199-66.7 36-137.3 56.3-212 62H0V214h199568c178.3-11.7  311.7-78.3 403-201 6-8 9.7-12 11-12 .7-.7 6.7-1 18-1s17.3.3 18 1c1.3 0 5 4 11  12 44.7 59.3 101.3 106.3 170 141s145.3 54.3 229 60h199572v120z"></path></svg></span><span class="brace-right" style="height:0.548em;"><svg height="0.548em" preserveAspectRatio="xMaxYMin slice" viewBox="0 0 400000 548" width="400em" xmlns="http://www.w3.org/2000/svg"><path d="M400000 542l -6 6h-17c-12.7 0-19.3-.3-20-1-4-4-7.3-8.3-10-13-35.3-51.3-80.8-93.8-136.5-127.5 s-117.2-55.8-184.5-66.5c-.7 0-2-.3-4-1-18.7-2.7-76-4.3-172-5H0V214h399571l6 1 c124.7 8 235 61.7 331 161 31.3 33.3 59.7 72.7 85 118l7 13v35z"></path></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.25em;"><span></span></span></span></span></span></span><span style="top:-5.1321em;"><span class="pstrut" style="height:3.398em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord text mtight"><span class="mord mtight"> unpaired</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.25em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:3.9584em;vertical-align:-1.4382em;"></span><span class="mord mover"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5202em;"><span style="top:-3.698em;"><span class="pstrut" style="height:3.698em;"></span><span class="mord mover"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.698em;"><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4382em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span><span class="svg-align" style="top:-4.2em;"><span class="pstrut" style="height:3.05em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg height="0.548em" preserveAspectRatio="xMinYMin slice" viewBox="0 0 400000 548" width="400em" xmlns="http://www.w3.org/2000/svg"><path d="M6 548l-6-6v-35l6-11c56-104 135.3-181.3 238-232 57.3-28.7 117 -45 179-50h399577v120H403c-43.3 7-81 15-113 26-100.7 33-179.7 91-237 174-2.7  5-6 9-10 13-.7 1-7.3 1-20 1H6z"></path></svg></span><span class="brace-center" style="height:0.548em;"><svg height="0.548em" preserveAspectRatio="xMidYMin slice" viewBox="0 0 400000 548" width="400em" xmlns="http://www.w3.org/2000/svg"><path d="M200428 334 c-100.7-8.3-195.3-44-280-108-55.3-42-101.7-93-139-153l-9-14c-2.7 4-5.7 8.7-9 14 -53.3 86.7-123.7 153-211 199-66.7 36-137.3 56.3-212 62H0V214h199568c178.3-11.7  311.7-78.3 403-201 6-8 9.7-12 11-12 .7-.7 6.7-1 18-1s17.3.3 18 1c1.3 0 5 4 11  12 44.7 59.3 101.3 106.3 170 141s145.3 54.3 229 60h199572v120z"></path></svg></span><span class="brace-right" style="height:0.548em;"><svg height="0.548em" preserveAspectRatio="xMaxYMin slice" viewBox="0 0 400000 548" width="400em" xmlns="http://www.w3.org/2000/svg"><path d="M400000 542l -6 6h-17c-12.7 0-19.3-.3-20-1-4-4-7.3-8.3-10-13-35.3-51.3-80.8-93.8-136.5-127.5 s-117.2-55.8-184.5-66.5c-.7 0-2-.3-4-1-18.7-2.7-76-4.3-172-5H0V214h399571l6 1 c124.7 8 235 61.7 331 161 31.3 33.3 59.7 72.7 85 118l7 13v35z"></path></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4382em;"><span></span></span></span></span></span></span><span style="top:-5.7321em;"><span class="pstrut" style="height:3.698em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord text mtight"><span class="mord mtight"> paired</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4382em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>exp</mtext><mo stretchy="false">(</mo><mo>−</mo><mtext>BaseEnergy</mtext><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">B(i, k) = \text{exp}(-\text{BaseEnergy}(i,k))</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">exp</span></span><span class="mopen">(</span><span class="mord">−</span><span class="mord text"><span class="mord">BaseEnergy</span></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">))</span></span></span></span>. This becomes a
standard dynamic programming problem. We can turn Z into a table of
values with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> cells. If cell <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0,0)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span> is on the bottom left, and
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(n-1,n-1)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> on the top right, each row of the table only depends on
the entries below and to the left. We can compute the full partition
function by starting from the bottom left and working out to the top
right in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>3</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^3)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> time. This is even parallelizable along the
diagonals (I’m not going to parallelize it here).</p>
<div class="highlight"><pre><span></span><code><span class="kr">type</span><span class="w"> </span><span class="kt">PFunArray</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Array</span><span class="w"> </span><span class="p">(</span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="kt">Double</span>

<span class="nf">boltz</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Double</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Double</span>
<span class="nf">boltz</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">exp</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

<span class="nf">partitionFunction</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">PFunArray</span>
<span class="nf">partitionFunction</span><span class="w"> </span><span class="n">strand</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">arr</span><span class="w">                           </span>
<span class="w">  </span><span class="kr">where</span>
<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="n">strand</span>
<span class="w">    </span><span class="n">arr</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">          </span><span class="p">[((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">pfCell</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">strand</span><span class="w"> </span><span class="n">arr</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="o">..</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

<span class="nf">pfCell</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">PFunArray</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Double</span>
<span class="nf">pfCell</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">strand</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">(</span><span class="n">sum</span><span class="w"> </span><span class="n">pairTerms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="n">slipTerm</span>
<span class="w">  </span><span class="kr">where</span>
<span class="w">    </span><span class="n">pairTerm</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">boltz</span><span class="w"> </span><span class="p">(</span><span class="n">baseEnergy</span><span class="w"> </span><span class="p">(</span><span class="n">strand</span><span class="w"> </span><span class="o">!!</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">strand</span><span class="w"> </span><span class="o">!!</span><span class="n">k</span><span class="p">))</span><span class="w"> </span><span class="o">*</span>
<span class="w">                   </span><span class="p">(</span><span class="kr">if</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                   </span><span class="p">(</span><span class="kr">if</span><span class="w"> </span><span class="n">j</span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">pairTerms</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="n">pairTerm</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">..</span><span class="n">j</span><span class="p">]]</span>
<span class="w">    </span><span class="n">slipTerm</span><span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span>
</code></pre></div>

<p><strong>Sampling RNA Structures</strong></p>
<p>To actually predict the structure of RNA molecules in nature, we can
work backward through the partition function table to sample structures
from the Boltzmann distribution. Consider the length of the strand along
base <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> to base <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>,</p>
<ul>
<li>the probability that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> is unpaired is equal to the sum of the
  probabilities of every structure along <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> unpaired,
  or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>Z</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><mrow><mi>Z</mi><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{Z[i+1, j]}{Z[i,j]}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.53em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">]</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>,</li>
<li>the probability that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> is
  paired to base <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> is equal
  to the sum of the probabilities of every structure along <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> where
  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> are
  paired, or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>B</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo><mi>Z</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>k</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mi>Z</mi><mo stretchy="false">[</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><mrow><mi>Z</mi><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{B(i,k)Z[i+1,k-1]Z[k+1,j]}{Z[i, j]}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.53em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">]</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mclose mtight">)</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">]</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span><span class="mopen mtight">[</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>,</li>
<li>completing the rest of the structure can be achieved by calling the
  sampling function recursively for every length of the strand left
  general, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> for the unpaired case, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k-1</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> and
  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k+1</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> for the second case.</li>
</ul>
<p>I encode this logic in Haskell below. At each level I roll a random
number from 0 to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">Z[i,j]</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span> and sort through the cases. When I pass
cumulative probability greater than the number I’ve rolled I choose
that case and recurse.</p>
<div class="highlight"><pre><span></span><code><span class="nf">sampleStructure</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">PFunArray</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">StdGen</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Structure</span>
<span class="nf">sampleStructure</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="n">strand</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kt">None</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="n">struct</span>
<span class="w">  </span><span class="kr">where</span>
<span class="w">    </span><span class="c1">-- setup pair terms</span>
<span class="w">    </span><span class="n">pairTerm</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">boltz</span><span class="w"> </span><span class="p">(</span><span class="n">baseEnergy</span><span class="w"> </span><span class="p">(</span><span class="n">strand</span><span class="w"> </span><span class="o">!!</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">strand</span><span class="w"> </span><span class="o">!!</span><span class="w"> </span><span class="n">k</span><span class="p">))</span><span class="w"> </span><span class="o">*</span>
<span class="w">                   </span><span class="p">(</span><span class="kr">if</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                   </span><span class="p">(</span><span class="kr">if</span><span class="w"> </span><span class="n">j</span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">pairTerms</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="n">pairTerm</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">..</span><span class="n">j</span><span class="p">]]</span>

<span class="w">    </span><span class="c1">-- structure functions</span>
<span class="w">    </span><span class="n">slipStructure</span><span class="w"> </span><span class="n">genr</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Slip</span><span class="w"> </span><span class="p">(</span><span class="n">strand</span><span class="w"> </span><span class="o">!!</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">sampleStructure</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="n">strand</span><span class="w"> </span><span class="n">genr</span><span class="p">)</span>
<span class="w">    </span><span class="n">innerPairStructure</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">genr</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">then</span><span class="w">  </span><span class="n">sampleStructure</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="n">strand</span><span class="w"> </span><span class="n">genr</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kt">None</span>
<span class="w">    </span><span class="n">outerPairStructure</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">genr</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="n">sampleStructure</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="n">strand</span><span class="w"> </span><span class="n">genr</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kt">None</span><span class="w">                                           </span>
<span class="w">    </span><span class="n">pairStructure</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">genr</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Paired</span><span class="w"> </span><span class="p">(</span><span class="n">strand</span><span class="w"> </span><span class="o">!!</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">strand</span><span class="w"> </span><span class="o">!!</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">innerPairStructure</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">genr</span><span class="p">,</span><span class="w"> </span><span class="n">outerPairStructure</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">genr</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- (cumulative probability, structure) pairs</span>
<span class="w">    </span><span class="n">slipCase</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">slipStructure</span><span class="p">)</span><span class="w"> </span><span class="c1">-- starting at offset of 0 </span>
<span class="w">    </span><span class="n">pairCases</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[(</span><span class="n">sum</span><span class="w"> </span><span class="p">(</span><span class="n">take</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">pairTerms</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">),</span><span class="w"> </span><span class="n">pairStructure</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">..</span><span class="n">j</span><span class="p">]]</span>
<span class="w">    </span><span class="n">allCases</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">slipCase</span><span class="kt">:</span><span class="n">pairCases</span>

<span class="w">    </span><span class="c1">-- sample a random number according to the current sub</span>
<span class="w">    </span><span class="p">(</span><span class="n">roll</span><span class="p">,</span><span class="w"> </span><span class="n">newgen</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">randomR</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="n">gen</span>
<span class="w">    </span><span class="c1">-- if roll &gt;= cumulative probability switch canidates, else not</span>
<span class="w">    </span><span class="n">checkCase</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">candidate</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="n">roll</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="n">fst</span><span class="w"> </span><span class="n">candidate</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="p">(</span><span class="n">snd</span><span class="w"> </span><span class="n">candidate</span><span class="p">)</span><span class="w"> </span><span class="n">newgen</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="n">current</span><span class="w"> </span>
<span class="w">    </span><span class="n">struct</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">foldl&#39;</span><span class="w"> </span><span class="n">checkCase</span><span class="w"> </span><span class="kt">None</span><span class="w"> </span><span class="n">allCases</span>
</code></pre></div>

<p><strong>Drawing Structures</strong></p>
<p>One last thing to do is to draw these structures, which I do using
<a href="https://byorgey.wordpress.com/">Brent Yorgey</a>‘s cool
<a href="http://projects.haskell.org/diagrams/">diagrams</a> library. Every base
is a circle with a letter underneath, color coded by base, with
backbone and arcs denoting bonds. This depicts RNA with the bonds
fanned out and visible, whereas other depictions of RNA will try to
keep the length of each bond pretty constant, which is a more physical
picture.</p>
<div class="highlight"><pre><span></span><code><span class="nf">colorMap</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="kr">of</span>
<span class="w">  </span><span class="sc">&#39;G&#39;</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">sRGB24read</span><span class="w"> </span><span class="s">&quot;#107896&quot;</span>
<span class="w">  </span><span class="sc">&#39;C&#39;</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">sRGB24read</span><span class="w"> </span><span class="s">&quot;#829356&quot;</span>
<span class="w">  </span><span class="sc">&#39;U&#39;</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">sRGB24read</span><span class="w"> </span><span class="s">&quot;#F26D21&quot;</span>
<span class="w">  </span><span class="sc">&#39;A&#39;</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">sRGB24read</span><span class="w"> </span><span class="s">&quot;#C02F1D&quot;</span>
<span class="w">  </span><span class="n">otherwise</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">white</span>

<span class="nf">base</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Char</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Diagram</span><span class="w"> </span><span class="kt">B</span>
<span class="nf">base</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">circle</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="n">fc</span><span class="w"> </span><span class="p">(</span><span class="n">colorMap</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span>
<span class="w">  </span><span class="n">text</span><span class="w"> </span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="n">fontSize</span><span class="w"> </span><span class="p">(</span><span class="n">local</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="n">translateY</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">2.6</span><span class="p">))</span>
<span class="nf">backbone</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">hrule</span><span class="w"> </span><span class="mi">1</span>

<span class="nf">isNone</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Structure</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Bool</span>
<span class="nf">isNone</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="kr">of</span>
<span class="w">  </span><span class="kt">None</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">True</span>
<span class="w">  </span><span class="n">otherwise</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">False</span>

<span class="nf">structLength</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Structure</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Int</span>
<span class="nf">structLength</span><span class="w"> </span><span class="kt">None</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">0</span>
<span class="nf">structLength</span><span class="w"> </span><span class="p">(</span><span class="kt">Slip</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">structLength</span><span class="w"> </span><span class="n">s</span>
<span class="nf">structLength</span><span class="w"> </span><span class="p">(</span><span class="kt">Paired</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">))</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">structLength</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">structLength</span><span class="w"> </span><span class="n">s2</span>

<span class="nf">renderStructure</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Structure</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Diagram</span><span class="w"> </span><span class="kt">B</span>
<span class="nf">renderStructure</span><span class="w"> </span><span class="p">(</span><span class="kt">Paired</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">))</span><span class="w"> </span><span class="ow">=</span><span class="w">  </span>
<span class="w">  </span><span class="n">base</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&gt;</span>
<span class="w">  </span><span class="n">translateX</span><span class="w"> </span><span class="mf">1.5</span><span class="w"> </span><span class="n">backbone</span><span class="w"> </span><span class="o">&lt;&gt;</span>
<span class="w">  </span><span class="n">translateX</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">innerElement</span><span class="w"> </span><span class="o">&lt;&gt;</span>
<span class="w">  </span><span class="n">translateX</span><span class="w"> </span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">k&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span>
<span class="w">  </span><span class="n">translateX</span><span class="w"> </span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">k&#39;</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">outerElement</span><span class="w"> </span><span class="o">&lt;&gt;</span>
<span class="w">  </span><span class="n">arc</span><span class="w"> </span><span class="n">xDir</span><span class="w"> </span><span class="p">(</span><span class="mf">0.5</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="n">turn</span><span class="p">)</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">k&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="n">translateX</span><span class="w"> </span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">k&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="kr">where</span>
<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">structLength</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">k&#39;</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">fromIntegral</span><span class="w"> </span><span class="n">k</span>
<span class="w">    </span><span class="n">innerElement</span><span class="w"> </span><span class="ow">=</span><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="n">isNone</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="n">mempty</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="n">renderStructure</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">|||</span><span class="w"> </span><span class="n">backbone</span>
<span class="w">    </span><span class="n">outerElement</span><span class="w"> </span><span class="ow">=</span><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="n">isNone</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="n">mempty</span>
<span class="w">      </span><span class="kr">else</span><span class="w">  </span><span class="n">translateX</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">)</span><span class="w"> </span><span class="n">backbone</span><span class="w"> </span><span class="o">&lt;&gt;</span>
<span class="w">            </span><span class="n">renderStructure</span><span class="w"> </span><span class="n">s2</span>
<span class="nf">renderStructure</span><span class="w"> </span><span class="p">(</span><span class="kt">Slip</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="n">isNone</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;&gt;</span>
<span class="w">  </span><span class="n">translateX</span><span class="w"> </span><span class="mf">1.5</span><span class="w"> </span><span class="n">backbone</span><span class="w"> </span><span class="o">&lt;&gt;</span>
<span class="w">  </span><span class="n">translateX</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">renderStructure</span><span class="w"> </span><span class="n">s</span><span class="p">)</span>
<span class="nf">renderStructure</span><span class="w"> </span><span class="kt">None</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">mempty</span>
</code></pre></div>

<p><strong>Example Output</strong></p>
<p>Let’s try it out:</p>
<div class="highlight"><pre><span></span><code><span class="nf">main</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="ow">=</span><span class="w">  </span><span class="n">mkStdGen</span><span class="w"> </span><span class="mi">42</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">rna</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot;GAAAAAAGGGGAAACCAAAGCCCAAUUUGCUUUUAAAAGGCCAA&quot;</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">pf</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">partitionFunction</span><span class="w"> </span><span class="n">rna</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">sampleStructure</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="n">rna</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">pf</span><span class="w"> </span><span class="n">rna</span><span class="w"> </span><span class="n">gen</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">diagram</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">renderStructure</span><span class="w"> </span><span class="n">struct</span>
<span class="w">  </span><span class="n">mainWith</span><span class="w"> </span><span class="n">diagram</span>
</code></pre></div>

<p>In shell:</p>
<div class="highlight"><pre><span></span><code>ghc RNAfolding.hs
RNAfolding.o -o RNAt.svg -w 600 -h 300
</code></pre></div>

<p><img alt="RNAt.svg" src="https://michaeljflynn.net/RNAt.svg"></p>
<p>Cool!</p>
<p><strong>Further Reading</strong></p>
<p>There is a long history of this problem being solved going back to the
1980’s even before John McCaskill first formulated a partition function
approach to RNA secondary structure prediction. Below are a couple
significant papers in this series, or at least those that are known to
me. I’ll also put my undergraduate thesis here, where I wrote
extensively on a slightly more complicated version of this problem.</p>
<p>Partition Functions:<br>
McCaskill, J.S., 1990. The equilibrium partition function and base pair
binding probabilities for RNA secondary structure. Biopolymers, 29(6‐7),
pp.1105-1119.
<a href="http://rna-informatics.uga.edu/Readings/prediction/1990-McCaskill-RNA-Partition-BP.pdf">pdf</a></p>
<p>Stochastic Sampling:<br>
Ding, Y. and Lawrence, C.E., 2003. A statistical sampling algorithm for
RNA secondary structure prediction. Nucleic acids research, 31(24),
pp.7280-7301.
<a href="http://nar.oxfordjournals.org/content/31/24/7280.full.pdf">pdf</a></p>
<p>More complicated energy models:<br>
Mathews, D.H., Sabina, J., Zuker, M. and Turner, D.H., 1999. Expanded
sequence dependence of thermodynamic parameters improves prediction of
RNA secondary structure. Journal of molecular biology, 288(5),
pp.911-940.
<a href="https://www.researchgate.net/profile/Michael_Zuker/publication/12969889_Expanded_sequence_dependence_of_thermodynamic_parameters_improves_prediction_of_RNA_secondary_structure1/links/0fcfd50b6962348011000000.pdf">pdf</a></p>
<p>Mathews, D.H., Disney, M.D., Childs, J.L., Schroeder, S.J., Zuker, M.
and Turner, D.H., 2004. Incorporating chemical modification constraints
into a dynamic programming algorithm for prediction of RNA secondary
structure. Proceedings of the National Academy of Sciences of the United
States of America, 101(19), pp.7287-7292.
<a href="http://www.pnas.org/content/101/19/7287.full.pdf">pdf</a></p>
<p>Some clear formulations, useful to me:<br>
Dirks, R.M. and Pierce, N.A., 2003. A partition function algorithm for
nucleic acid secondary structure including pseudoknots. Journal of
computational chemistry, 24(13), pp.1664-1677.
<a href="http://piercelab.caltech.edu/assets/papers/jcc03b.pdf">pdf</a></p>
<p>RNAbows:<br>
Aalberts, D.P. and Jannen, W.K., 2013. Visualizing RNA base-pairing
probabilities with RNAbow diagrams. RNA, 19(4), pp.475-478.
<a href="http://rnajournal.cshlp.org/content/19/4/475.full.pdf">pdf</a></p>
<p>My thesis:<br>
Flynn, M.J. and Aalberts, D.P., 2015. RNA Macrostates and Computational
Tools. Williams College. <a href="https://github.com/MichaelJFlynn/Thesis/blob/master/main.pdf">github
pdf</a></p>
<h3>4 Comments</h3>
<ol>
<li>
<p><img
    src="http://0.gravatar.com/avatar/c46d3353240bbbbc68cd53f3b637a056?s=48&amp;d=mm&amp;r=g"
    class="avatar avatar-48 photo"
    srcset="http://0.gravatar.com/avatar/c46d3353240bbbbc68cd53f3b637a056?s=96&amp;d=mm&amp;r=g 2x"
    itemprop="image" width="48" height="48" />
    <a href="http://wrmsr.com/"
    class="url fn n" rel="external nofollow" itemprop="url"><span
    itemprop="name">wrmsr</span></a></p>
<p>January 10, 2017 at 4:13 am</p>
<p>Awesome article, in all of content, intersectionality, and
presentaion. Have a possible slight correction though that made me
stop and double-check:</p>
<p>The sum <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><mo>∑</mo><mi mathvariant="normal">_</mi><mrow><mi>s</mi><mtext>’</mtext><mo>∈</mo><mi>S</mi></mrow><msup><mi>e</mi><mrow><mo>−</mo><mi>E</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>k</mi><mi>T</mi></mrow></msup></mrow><annotation encoding="application/x-tex">Z = \sum\_{s’ \in S} e^{-E(s)/kT}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.198em;vertical-align:-0.31em;"></span><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord"><span class="mord mathnormal">s</span><span class="mord">’</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">s</span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> initially seems daunting.</p>
<p>Shouldn’t this be:</p>
<p>The sum <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><mo>∑</mo><mi mathvariant="normal">_</mi><mrow><mi>s</mi><mtext>’</mtext><mo>∈</mo><mi>S</mi></mrow><msup><mi>e</mi><mrow><mo>−</mo><mi>E</mi><mo stretchy="false">(</mo><mi>s</mi><mtext>’</mtext><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>k</mi><mi>T</mi></mrow></msup></mrow><annotation encoding="application/x-tex">Z = \sum\_{s’ \in S} e^{-E(s’)/kT}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.198em;vertical-align:-0.31em;"></span><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord"><span class="mord mathnormal">s</span><span class="mord">’</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">s</span><span class="mord mtight">’</span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> initially seems daunting.</p>
<p>Still processing the rest :p</p>
<ul>
<li><img
  src="http://0.gravatar.com/avatar/64ca2c1540eb6254acb10aec1958655c?s=48&amp;d=mm&amp;r=g"
  class="avatar avatar-48 photo"
  srcset="http://0.gravatar.com/avatar/64ca2c1540eb6254acb10aec1958655c?s=96&amp;d=mm&amp;r=g 2x"
  itemprop="image" width="48" height="48" /> mflynn</li>
</ul>
<p>January 10, 2017 at 4:24
  am</p>
<p>Yes! Thanks.</p>
</li>
<li>
<p><img
    src="http://0.gravatar.com/avatar/cc113924265dbeb535c8b2fefe4e33ee?s=48&amp;d=mm&amp;r=g"
    class="avatar avatar-48 photo"
    srcset="http://0.gravatar.com/avatar/cc113924265dbeb535c8b2fefe4e33ee?s=96&amp;d=mm&amp;r=g 2x"
    itemprop="image" width="48" height="48" /> Brent Yorgey</p>
<p>January 10, 2017 at 9:49 pm</p>
<p>Hey, this is really cool. I think I remember you trying to explain
some of this to me a couple years ago, though I’m not sure I really
got it at the time (it makes a lot of sense now, though).</p>
<p>Also, nice pictures! 😉</p>
<ul>
<li><img
  src="http://0.gravatar.com/avatar/64ca2c1540eb6254acb10aec1958655c?s=48&amp;d=mm&amp;r=g"
  class="avatar avatar-48 photo"
  srcset="http://0.gravatar.com/avatar/64ca2c1540eb6254acb10aec1958655c?s=96&amp;d=mm&amp;r=g 2x"
  itemprop="image" width="48" height="48" /> mflynn</li>
</ul>
<p>January 11, 2017 at 4:57
  am</p>
<p>Thanks! Glad you thought it was cool. Diagrams is very useful!</p>
</li>
</ol>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2017-01-09T00:56:00-08:00">Mon 09 January 2017</time>
            <h4>Category</h4>
            <a class="category-link" href="https://michaeljflynn.net/categories.html#misc-ref">misc</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://michaeljflynn.net/tags.html#computational-physics-ref">Computational Physics
                    <span class="superscript">2</span>
</a></li>
                <li><a href="https://michaeljflynn.net/tags.html#dynamic-programming-ref">Dynamic Programming
                    <span class="superscript">1</span>
</a></li>
                <li><a href="https://michaeljflynn.net/tags.html#haskell-ref">Haskell
                    <span class="superscript">1</span>
</a></li>
                <li><a href="https://michaeljflynn.net/tags.html#partition-function-ref">Partition Function
                    <span class="superscript">1</span>
</a></li>
                <li><a href="https://michaeljflynn.net/tags.html#recursion-ref">Recursion
                    <span class="superscript">1</span>
</a></li>
                <li><a href="https://michaeljflynn.net/tags.html#rna-ref">RNA
                    <span class="superscript">1</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                </div>
            </div>
        </div>
<footer>
    <div>
        Content licensed under CC BY 4.0
    </div>




    <div id="fpowered">
        Powered by <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>.
        Theme based on <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>.
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://michaeljflynn.net/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>